<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Page - Klarna Payment Selector</title>
    <link rel="preconnect" href="https://x.klarnacdn.net" crossorigin>
    <link
      rel="stylesheet"
      href="https://x.klarnacdn.net/ui/fonts/v1.5/fonts.css"
    >
    <link
      rel="stylesheet"
      href="https://js.klarna.com/web-sdk/buttons/payment-button.css"
    >
    <link rel="stylesheet" href="/styles.css">
    <style>
      body {
        font-family: 'Klarna Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        margin: 0 !important;
        padding: 0 !important;
        background-color: #F9F8F5 !important;
        color: #0B051D !important;
        display: flex !important;
        justify-content: center !important;
        min-height: 100vh !important;
        max-width: none !important;
        overflow-x: hidden !important;
      }
      
      html {
        margin: 0;
        padding: 0;
      }
      
      .product-container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 2rem;
        position: relative;
      }
      
      .product-header {
        width: 100%;
      }
      
      .product-content {
        width: 100%;
      }
      
      .settings-icon,
      .log-icon {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: white;
        border: 1px solid #E0E0E0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: all 0.2s;
      }
      
      .log-icon {
        top: auto;
        bottom: 20px;
      }
      
      .settings-icon:hover,
      .log-icon:hover {
        background: #F5F5F5;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .settings-icon svg,
      .log-icon svg {
        width: 20px;
        height: 20px;
        stroke: #0B051D;
      }
      
      .settings-panel {
        position: fixed;
        top: 70px;
        right: 20px;
        width: 400px;
        max-width: calc(100vw - 40px);
        background: white;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        z-index: 999;
        display: none;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
      }
      
      .settings-panel.open {
        display: block;
      }
      
      .settings-panel-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #E0E0E0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .settings-panel-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      
      .settings-panel-content {
        padding: 1.5rem;
      }
      
      .settings-field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .settings-field-full {
        grid-column: 1 / -1;
      }
      
      .settings-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .settings-field label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #5A5A5A;
      }
      
      .settings-field select,
      .settings-field input {
        padding: 0.5rem;
        border: 1px solid #E0E0E0;
        border-radius: 4px;
        font-size: 0.9rem;
        font-family: 'Klarna Text', sans-serif;
      }
      
      .settings-field select:focus,
      .settings-field input:focus {
        outline: none;
        border-color: #0B051D;
      }
      
      .settings-status {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #F5F5F5;
        border-radius: 4px;
        font-size: 0.875rem;
      }
      
      .settings-status .pill {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: #E0E0E0;
        border-radius: 4px;
        font-weight: 500;
      }
      
      .product-header {
        margin-bottom: 2rem;
      }
      
      .back-link {
        color: #0B051D;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      
      .back-link:hover {
        text-decoration: underline;
      }
      
      .product-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        margin-bottom: 3rem;
      }
      
      .product-image {
        width: 100%;
        height: 500px;
        background: linear-gradient(135deg, #FFA8CD 0%, #FFE9F3 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #0B051D;
      }
      
      .product-info {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .product-title {
        font-family: 'Klarna Title', sans-serif;
        font-size: 2rem;
        margin: 0;
        color: #0B051D;
      }
      
      .product-price {
        font-family: 'Klarna Title', sans-serif;
        font-size: 2.5rem;
        color: #0B051D;
        margin: 0;
      }
      
      .product-description {
        line-height: 1.6;
        color: #5A5A5A;
      }
      
      #product-payment-button-container {
        width: 100%;
        min-height: 60px;
        display: block;
        margin-top: 1.5rem;
      }
      
      
      @media (max-width: 768px) {
        .product-content {
          grid-template-columns: 1fr;
        }
        
        .settings-panel {
          width: calc(100vw - 40px);
          right: 20px;
          left: 20px;
        }
        
        .settings-field-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sticky banner when no Paytrail credentials (fixed at top so it stays above content) -->
    <div id="paytrail-credentials-banner" style="display: none; width: 100%; box-sizing: border-box; position: fixed; top: 0; left: 0; right: 0; z-index: 1500; background: #FEF3C7; border-bottom: 1px solid #F59E0B; padding: 0.5rem 1rem; min-height: 48px; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
      <span style="font-size: 0.9rem; color: #92400E;">No Paytrail API credentials are set. Provide them to test the API.</span>
      <button type="button" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; background: #0B051D; color: #fff; border: 2px solid #0B051D; border-radius: 6px; cursor: pointer;" onclick="window.showPaytrailCredentialsModalProduct && window.showPaytrailCredentialsModalProduct()">Enter credentials</button>
    </div>
    <!-- Settings Icon -->
    <div class="settings-icon" id="settings-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </div>
    
    <!-- Log Icon -->
    <div class="log-icon" id="log-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-panel-header">
        <h3>Settings</h3>
        <span class="collapse-icon" id="settings-close-icon" style="cursor: pointer; font-size: 0.875rem;">‚úï</span>
      </div>
      <div class="settings-panel-content">
        <div class="settings-field-row">
          <div class="settings-field">
            <label for="product-country">Purchase country</label>
            <select id="product-country"></select>
          </div>
          <div class="settings-field">
            <label for="product-locale">Locale</label>
            <select id="product-locale"></select>
          </div>
        </div>
        <div class="settings-field-row">
          <div class="settings-field settings-field-full">
            <label for="product-amount">Amount (minor units)</label>
            <input id="product-amount" type="number" min="0" step="1" value="15900" />
          </div>
        </div>
        <div class="settings-field-row">
          <div class="settings-field settings-field-full">
            <label for="product-payment-endpoint">Authorize payment via</label>
            <select id="product-payment-endpoint">
              <option value="/payments">/payments</option>
              <option value="/payments-hpp">/payments (HPP)</option>
              <option value="/payments/klarna/charge">/payments/klarna/charge (auto-capture)</option>
              <option value="/payments/klarna/authorization-hold">/payments/klarna/authorization-hold (manual capture)</option>
            </select>
          </div>
        </div>
        <div class="settings-field-row">
          <div class="settings-field settings-field-full">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input id="skip-paytrail-request" type="checkbox" style="cursor: pointer;" />
              <span>Don't send Paytrail's payment request</span>
            </label>
          </div>
        </div>
        <div class="settings-status">
          Currency: <span id="product-currency-pill" class="pill">‚Äî</span>
        </div>
      </div>
    </div>
    
    <!-- Product Container -->
    <div class="product-container">
      <div class="product-header">
        <a href="/" class="back-link">
          ‚Üê Back to Demo Store
        </a>
      </div>
      
      <div class="product-content">
        <div class="product-image">
          üõçÔ∏è
        </div>
        
        <div class="product-info">
          <h1 class="product-title">Demo Product</h1>
          <p class="product-price" id="product-price">‚Ç¨159.00</p>
          <div class="product-description">
            <p>Experience premium quality with our carefully crafted product. Designed with attention to detail and built to last, this item combines style and functionality to meet your everyday needs.</p>
          </div>
          
          <!-- On-site messaging placement -->
          <div id="osm-placement" style="margin-bottom: 1.5rem;"></div>
          
          <div id="product-payment-button-container"></div>
        </div>
      </div>
    </div>

    <!-- Credentials modal (triggered by banner) -->
    <div id="paytrail-credentials-modal" style="display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.4); align-items: center; justify-content: center;" onclick="if(event.target===this) window.closePaytrailCredentialsModalProduct && window.closePaytrailCredentialsModalProduct()">
      <div style="background: #fff; border-radius: 8px; padding: 1.5rem; max-width: 420px; margin: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15);" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
          <p style="font-weight: 600; margin: 0; color: #0B051D;">Paytrail credentials</p>
          <button type="button" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" onclick="window.closePaytrailCredentialsModalProduct && window.closePaytrailCredentialsModalProduct()" title="Close" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <p style="font-size: 0.9rem; color: #2C2242; margin-bottom: 1rem;">Enter your Paytrail credentials. They're stored only in your browser.</p>
        <div style="margin-bottom: 0.75rem;">
          <label for="paytrail-modal-merchant-id" style="font-size: 0.85rem; color: #0B051D;">Merchant ID</label>
          <input type="text" id="paytrail-modal-merchant-id" placeholder="PAYTRAIL_MERCHANT_ID" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #E4E3DF; border-radius: 4px; margin-top: 0.25rem; font-size: 0.9rem; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label for="paytrail-modal-secret-key" style="font-size: 0.85rem; color: #0B051D;">Secret key</label>
          <input type="password" id="paytrail-modal-secret-key" placeholder="PAYTRAIL_SECRET_KEY" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #E4E3DF; border-radius: 4px; margin-top: 0.25rem; font-size: 0.9rem; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label for="paytrail-modal-klarna-client-id" style="font-size: 0.85rem; color: #0B051D;">Klarna WebSDK Client ID</label>
          <input type="text" id="paytrail-modal-klarna-client-id" placeholder="Klarna WebSDK Client ID (optional)" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #E4E3DF; border-radius: 4px; margin-top: 0.25rem; font-size: 0.9rem; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 1rem;">
          <label for="paytrail-modal-klarna-api-key" style="font-size: 0.85rem; color: #0B051D;">Klarna API Key</label>
          <input type="password" id="paytrail-modal-klarna-api-key" placeholder="Klarna API Key (optional)" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #E4E3DF; border-radius: 4px; margin-top: 0.25rem; font-size: 0.9rem; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 1rem;">
          <span style="font-size: 0.85rem; color: #0B051D;">Environment (Klarna API)</span>
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.35rem; cursor: pointer; font-size: 0.9rem;">
              <input type="radio" name="paytrail-modal-klarna-environment-product" value="playground" id="paytrail-modal-env-playground-product">
              Playground
            </label>
            <label style="display: flex; align-items: center; gap: 0.35rem; cursor: pointer; font-size: 0.9rem;">
              <input type="radio" name="paytrail-modal-klarna-environment-product" value="production" id="paytrail-modal-env-production-product">
              Production
            </label>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="button" style="flex: 1; padding: 0.75rem; background: #0B051D; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" onclick="window.savePaytrailCredentialsFromModalProduct && window.savePaytrailCredentialsFromModalProduct()">Save</button>
          <button type="button" style="flex: 1; padding: 0.75rem; background: #E4E3DF; color: #0B051D; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" onclick="window.closePaytrailCredentialsModalProduct && window.closePaytrailCredentialsModalProduct()">Close</button>
        </div>
      </div>
    </div>

    <script src="/js/credentials-storage.js"></script>
    <script type="module" src="/js/flow-logger.js"></script>
    <script type="module" src="/js/product.js"></script>
    <script>
      (function() {
        var PAYTRAIL_MID = 'paytrail_merchant_id';
        var PAYTRAIL_SK = 'paytrail_secret_key';
        var KLARNA_CLIENT_ID = 'klarna_websdk_client_id';
        var KLARNA_API_KEY = 'klarna_api_key';
        var KLARNA_ENVIRONMENT = 'klarna_environment';
        function getCred(key) { return window.CredentialStorage && window.CredentialStorage.get(key); }
        function setCred(key, val) { if (window.CredentialStorage) window.CredentialStorage.set(key, val); }
        function hasCreds() {
          return !!(window.CredentialStorage && window.CredentialStorage.hasPaytrailCredentials());
        }
        function updateBanner() {
          var b = document.getElementById('paytrail-credentials-banner');
          if (!b) return;
          var storageOk = window.CredentialStorage && window.CredentialStorage.storageAvailable();
          var span = b.querySelector('span');
          if (!storageOk) {
            b.style.display = 'flex';
            document.body.style.paddingTop = '64px';
            if (span) span.textContent = 'Browser storage is disabled or not persisting. Enable cookies/storage for this site or use a normal (non-private) window to save credentials.';
          } else {
            if (span) span.textContent = 'No Paytrail API credentials are set. Provide them to test the API.';
            var show = !hasCreds();
            b.style.display = show ? 'flex' : 'none';
            document.body.style.paddingTop = show ? '64px' : '0';
          }
        }
        window.updatePaytrailCredentialsBannerProduct = updateBanner;
        window.showPaytrailCredentialsModalProduct = function() {
          var modal = document.getElementById('paytrail-credentials-modal');
          var midEl = document.getElementById('paytrail-modal-merchant-id');
          var skEl = document.getElementById('paytrail-modal-secret-key');
          var klarnaEl = document.getElementById('paytrail-modal-klarna-client-id');
          var klarnaKeyEl = document.getElementById('paytrail-modal-klarna-api-key');
          var env = getCred(KLARNA_ENVIRONMENT) || 'playground';
          if (midEl) midEl.value = getCred(PAYTRAIL_MID) || '';
          if (skEl) skEl.value = getCred(PAYTRAIL_SK) || '';
          if (klarnaEl) klarnaEl.value = getCred(KLARNA_CLIENT_ID) || '';
          if (klarnaKeyEl) klarnaKeyEl.value = getCred(KLARNA_API_KEY) || '';
          var envPlayground = document.getElementById('paytrail-modal-env-playground-product');
          var envProduction = document.getElementById('paytrail-modal-env-production-product');
          if (envPlayground) envPlayground.checked = (env !== 'production');
          if (envProduction) envProduction.checked = (env === 'production');
          if (modal) modal.style.display = 'flex';
        };
        window.closePaytrailCredentialsModalProduct = function() {
          var modal = document.getElementById('paytrail-credentials-modal');
          if (modal) modal.style.display = 'none';
        };
        window.savePaytrailCredentialsFromModalProduct = function() {
          var midEl = document.getElementById('paytrail-modal-merchant-id');
          var skEl = document.getElementById('paytrail-modal-secret-key');
          var klarnaEl = document.getElementById('paytrail-modal-klarna-client-id');
          var klarnaKeyEl = document.getElementById('paytrail-modal-klarna-api-key');
          if (!midEl || !skEl) return;
          var mid = midEl.value.trim();
          var sk = skEl.value.trim();
          if (!mid || !sk) return;
          if (!window.CredentialStorage || !window.CredentialStorage.storageAvailable()) {
            alert('Browser storage is disabled or not persisting. Enable cookies/storage for this site or use a normal (non-private) window.');
            return;
          }
          var klarnaId = klarnaEl ? klarnaEl.value.trim() : '';
          var klarnaKey = klarnaKeyEl ? klarnaKeyEl.value.trim() : '';
          var envEl = document.querySelector('input[name="paytrail-modal-klarna-environment-product"]:checked');
          var env = (envEl && envEl.value) || 'playground';
          setCred(PAYTRAIL_MID, mid);
          setCred(PAYTRAIL_SK, sk);
          setCred(KLARNA_CLIENT_ID, klarnaId || null);
          setCred(KLARNA_API_KEY, klarnaKey || null);
          setCred(KLARNA_ENVIRONMENT, env);
          window.closePaytrailCredentialsModalProduct();
          updateBanner();
        };
        function initCredentialsBanner() { updateBanner(); }
        initCredentialsBanner();
        document.addEventListener('DOMContentLoaded', initCredentialsBanner);
        window.addEventListener('pageshow', function() { initCredentialsBanner(); });
        setTimeout(initCredentialsBanner, 50);
        setTimeout(initCredentialsBanner, 200);
      })();
      // Settings panel toggle
      const settingsIcon = document.getElementById('settings-icon');
      const settingsPanel = document.getElementById('settings-panel');
      const settingsCloseIcon = document.getElementById('settings-close-icon');
      
      settingsIcon.addEventListener('click', () => {
        settingsPanel.classList.toggle('open');
      });
      
      settingsCloseIcon.addEventListener('click', () => {
        if (window.saveProductPageAmount) window.saveProductPageAmount();
        settingsPanel.classList.remove('open');
      });
      
      // Close settings panel when clicking outside
      document.addEventListener('click', (e) => {
        if (!settingsPanel.contains(e.target) && !settingsIcon.contains(e.target)) {
          if (window.saveProductPageAmount) window.saveProductPageAmount();
          settingsPanel.classList.remove('open');
        }
      });
      
      // Log icon toggle
      const logIcon = document.getElementById('log-icon');
      logIcon.addEventListener('click', () => {
        if (window.toggleLogPanelVisibility) {
          window.toggleLogPanelVisibility();
        } else {
          // Fallback: wait for the function to be available
          setTimeout(() => {
            if (window.toggleLogPanelVisibility) {
              window.toggleLogPanelVisibility();
            }
          }, 100);
        }
      });
    </script>
  </body>
</html>
